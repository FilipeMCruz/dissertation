\chapter{Design}
\label{chap:design}

This section goal is to describe the overall system design to the reader.
First the reference architectures used for this project will be presented. Then the various system scopes will be introduced, followed by section regarding the domain model.
After this the system's architectural design will be presented and major decisions/alternatives discussed. At last, a synopsis of this chapter can be read.

\section{Reference Architecture}
\label{sec:design:ref_architecture}

TODO

\section{System Scopes}
\label{sec:design:system_scopes}

The system designed can be divided is three main scopes as disclosed in the Figure~\ref{fig:design:system_scopes:scopes}.

\begin{figure}[H]
    \centering
   \resizebox{\columnwidth}{!}
   {
      \input{assets/diagrams/scopes.latex}
   }
   \caption[System Scopes]{System Scopes}
   \label{fig:design:system_scopes:scopes}
\end{figure}

The \textbf{Configuration Scope} adheres to the configuration and visualization of internal processes/contexts. This processes, such as: (i) data decoders, (ii) device inventory, (iii) warning rules definition and (iv) device ownership, are related to the \textbf{Data Flow Scope}. It is also possible to manage tenants' access and permissions in the system in this scope.

The \textbf{Data Flow Scope} behaves according to what is defined in the \textbf{Configuration Scope} and acts as a pipeline where raw device data goes though various stages till it is sanitized and ready to be supplied to the \textbf{Services Scope}. The \textbf{Data Flow Scope} is where internal processes occur, such as: (i) data transformation, (ii) data enrichment, (iii) data validation, (iv) data ownership clarification and (v) warnings dispatching.

The \textbf{Services Scope} is comprised of services that present and act according to the sanitized data that was supplied to them. This services applicability range from (i) smart irrigation, (ii) fleet management, (iii) fire detention, (iv) physical security access monitoring, (v) air quality monitoring and anything else deemed interesting.

\subsection{Configuration Scope}
\label{subsec:design:system_scopes:configuration_scope}

The \textbf{Configuration Scope} is responsible for managing the following contexts:

\begin{itemize}
   \item \textbf{Data Processor}: manages simple data mappers;
   \item \textbf{Data Decoder}: manages scripts to transform data;
   \item \textbf{Device Management}: manages device information such as name, metadata, static data and other notions;
   \item \textbf{Identity Management}: manages device ownership and users permissions;
   \item \textbf{Rule Management}: manages scripts that consume device data and produce alerts.
\end{itemize}

Each context allows an authorized user to manage its resources, e.g. the data processor context manages the creation, deletion and renovation of data mappers.

This operations require various verifications, alter the system internal state and are therefore prolonged operations.

\subsection{Data Flow Scope}
\label{subsec:design:system_scopes:data_flow_scope}

The \textbf{Data Flow Scope} is responsible for processing incoming data according to what is defined in the \textbf{Configuration Scope}. Both scopes share the same contexts, apart from the data validation context (only present in this scope).

The data validation context preforms basic data filtering based on static rules, e.g. battery percentage reported has to be in between 0 and 100.

This scope applies changes to the device data that flows though the system. This changes are stateless and don't change the overall state of the internal system state.

This scope was decoupled from the \textbf{Configuration Scope} even though they both work with the same contexts. The decision was taken based on the pretext that despite the similarities in context the operation/business processes of this two scopes were conflicting.

The \textbf{Configuration Scope} requires scarce but heavy computations that alter the internal system state while the \textbf{Data Flow Scope} requires plentiful but light computations that don't alter the internal system state as summarized in the Table~\ref{tab:design:system_scopes:data_flow_scope:comparison}.

\begin{table}[!ht]
   \centering
   \begin{tabular}{@{}lllll@{}}
   \toprule
   \textbf{Comparison of Operations} & \textbf{Configuration Scope} & \textbf{Data Flow Scope} \\ \midrule
       Alter internal system state & yes & no \\ \hline
       Alter sensor data & no & yes \\ \hline
       Required computation power/time & high & low \\ \hline
       Frequency of usage & low & high \\ \hline
   \end{tabular}
   \caption[Comparison of Operations in Data Flow and Configuration Scopes]{Comparison of Operations in Data Flow and Configuration Scopes}
   \label{tab:design:system_scopes:data_flow_scope:comparison}
\end{table}

Due to this discrepancy it's expected for each scope to have different requirements regarding horizontal scaling. With the addition of more devices to the platform, and subsequently higher ingress volume, \textbf{Data Flow Scope} will need to scale. Since the \textbf{Configuration Scope} is intended mostly for the manager of the platform, a small user pool, the need to scale is smaller.

\subsection{Service Scope}
\label{subsec:design:system_scopes:service_scope}

The \textbf{Service Scope} is responsible for presenting \gls{IoT} business cases to end users. This scope is comprised of services that consume and publish data to \textbf{Data Flow Scope}. Currently, as a \gls{MVP} the following business cases implemented are:

\begin{itemize}
   \item \textbf{Fleet Management}: basic service to monitor a fleet of cars regarding their location;
   \item \textbf{Smart Irrigation}: service to automate and monitor the irrigation of zones based on sensor readings;
   \item \textbf{Notification Management}: service to view and manage the delivery of triggered alerts.
\end{itemize}

Each service is bounded to what type of data receives and sends back to the \textbf{Data Flow Scope} as detailed in Sections~\ref{subsec:design:domain:concepts} and \ref{subsec:design:domain:shared_model}.

\subsection{Synopsis}
\label{subsec:design:system_scopes:synopsis}

This section introduces the system as three separated scopes each with different needs and responsibilities. Despite this they all have a common domain model. The Section~\ref{sec:design:domain} addresses this shared domain and each context peculiarity.

\section{Domain}
\label{sec:design:domain}

This system's domain model will be discussed here. The idea behind this section is to introduced core business concepts to the reader and explain how they map to the contexts present in the system. To represent this ideas the \gls{UML} notation is used.

This section is split into four pieces: (i) concepts, (ii) shared model, (iii) bounded contexts and (iv) synopsis.

\subsection{Concepts}
\label{subsec:design:domain:concepts}

In order for the reader to better understand how the system functions some concepts need to be better explained:

\begin{itemize}
   \item \textbf{Device}: A device is a "Thing" that can collect data and submit it to \textbf{Sensae Console} via an external system though \textbf{Uplink}s. A device can, optionally, receive \textbf{Downlink}s;
   \item \textbf{Controller}: A controller is a \textbf{Device} that controls and aggregates data from various \textbf{Device}s;
   \item \textbf{Records/Metadata}: Records, or Metadata are labels associated to a \textbf{Device} that help an organization to classify and add some context to the owned \textbf{Device}s;
   \item \textbf{Downlink}: A downlink is a term commonly used in radio communications to denote the transmission from the network to the end user. In this case the network is the \textbf{Sensae Console} and the end user is a \textbf{Device};
   \item \textbf{Uplink}: An uplink is the opposite of a \textbf{Downlink}, it's the transmission from a \textbf{Device} to the \textbf{Sensae Console};
   \item \textbf{Data Unit}: A device data or measure is the collected data that is submitted via an \textbf{Uplink} to the \textbf{Sensae Console}. This data should be, at least, enriched with an unique identifier of the \textbf{Uplink} and \textbf{Device} that sent it;
   \item \textbf{Device Command}: A device command is an abstraction on top of a \textbf{Downlink} intended to order a \textbf{Device} to execute a specific action. As an example, one could send a command to open or close a valve that is incorporated into a \textbf{Controller};
   \item \textbf{Decoder}: A decoder is a function that translates a \textbf{Data Unit} into something that \textbf{Sensae Console} understands;
   \item \textbf{Domain}: A domain represents a department in a organization. An organization is composed of several domains structured in a tree like format;
   \item \textbf{Tenant}: A tenant is a user that belongs to one or more \textbf{Domain}s;
   \item \textbf{Alert/Warning}: A report about a detected condition based on the gather \textbf{Data Unit};
   \item \textbf{Topic}: A Topic is a subcategory of the type of contents that are traded between the various containers in the system.
\end{itemize}

Currently the \textbf{Topic}s that flow in the system are:

\begin{itemize}
   \item \textbf{Data}: This topic references the \textbf{Data Unit} concept and is intended to be consumed by the \textbf{Service Scope};
   \item \textbf{Command}: This topic references the \textbf{Device Command} concept and is intended to be used mainly by the \textbf{Service Scope};
   \item \textbf{Alert}: This topic references the \textbf{Alert/Warning} concept and is intended to be consumed mainly by the \textbf{Service Scope};
   \item \textbf{Internal}: This topic references the internal state maintained in the \textbf{Configuration Scope} and \textbf{Data Flow Scope}.
\end{itemize}

This concepts are referenced across the document.

\subsection{Shared Model}
\label{subsec:design:domain:shared_model}

The shared model is comprised of concepts that transverse the entire \textbf{Sensae Console} business model. Therefore, it is built as a separated project, \textit{iot-core}, that can be imported in each micro service.
It is comprised of three big components: (i) data model, (ii) message envelop model, and (iii) routing model. 

\subsubsection*{Data Model}
\label{subsubsec:design:domain:shared_model:data}

The data model represents the \textbf{Data Unit} that \textbf{Sensae Console} is currently capable of understanding. The following diagram, Figure~\ref{fig:design:domain:shared_model:data:diagram}, introduces a high level specification of it.

\begin{figure}[H]
   \centering
  \resizebox{\columnwidth}{!}
  {
     \input{assets/diagrams/shared-model.latex}
  }
  \caption[Shared Model]{Shared Model}
  \label{fig:design:domain:shared_model:data:diagram}
\end{figure}

As a brief description:

\begin{itemize}
   \item \textbf{Data Unit} is represented in the diagram as \textit{Data} and is the entry point to the shared model;
   \item The \textit{reportedAt} field represents the unix timestamp when the \textbf{Data Unit} was captured, in milliseconds;
   \item The \textit{Device} concept represents the \textbf{Device} that sent the \textit{Data}, and therefore the \textit{Data};
   \item The \textit{Record} concept represents an entry of \textbf{Records/Metadata};
   \item The \textit{Domain} concept references the \textbf{Domain} that owns the \textit{Device};
   \item The \textit{SubDeviceMeasures} concept introduces an approach to handle \textbf{Controller}s by mapping readings captured by a sub device to a \textit{reference} that can later be resolved;
   \item The \textit{SubDeviceCommands} concept introduces an approach to handle \textbf{Controller}s by mapping commands tailored for a sub device to a \textit{reference} that can later be resolved;
   \item The \textit{Measures} concept contains various common data types related to \gls{IoT}.
\end{itemize}

As explained, \textit{Measures} contains various data types. Currently the supported types are presented in the Table~\ref{tab:design:domain:shared_model:data:data_types}.

\begin{landscape}
   \begin{longtable}{cllll}
   \cline{1-4}
   \multicolumn{2}{l}{\textbf{Data Type}}                                     & \multirow{2}{*}{\textbf{Description}}                  & \multirow{2}{*}{\textbf{Unit}} &  \\
   \textit{Property}                     & \textit{Sub Property}              &                                                        &                                &  \\ \cline{1-4}
   \endfirsthead
   %
   \multicolumn{5}{c}%
   {{\bfseries Table \thetable\ continued from previous page}} \\
   \cline{1-4}
   \multicolumn{2}{l}{\textbf{Data Type}}                                     & \multirow{2}{*}{\textbf{Description}}                  & \multirow{2}{*}{\textbf{Unit}} &  \\
   \textit{Property}                     & \textit{Sub Property}              &                                                        &                                &  \\ \cline{1-4}
   \endhead
   %
   \cline{1-4}
   \endfoot
   %
   \endlastfoot
   %
   \multicolumn{2}{l}{\textbf{GPS}}                                           & \multicolumn{2}{l}{Point reference in the Geographic Coordinate System}                 &  \\
   \multirow{3}{*}{\textit{gps}}         & \textit{latitude}                  & Value between -90 and 90 measured in                   & degrees                        &  \\
                                         & \textit{longitude}                 & Value between -180 and 180 measured in                 & degrees                        &  \\
                                         & \textit{altitude}                  & Value determined according to the mean sea level       & meters                         &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{Motion}}                                        & \multicolumn{2}{l}{Status related to the motion of a device}                            &  \\
   \textit{motion}                       & \textit{value}                     & Value can be "ACTIVE", "INACTIVE" or "UNKNOWN"         & n.a.                           &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{Velocity}}                                      & \multicolumn{2}{l}{How fast a device is moving}                                         &  \\
   \textit{velocity}                     & \textit{kilometerPerHour}          & Value measured in                                      & km/h                           &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{Temperature}}                                   & \multicolumn{2}{l}{Temperature measured by a device}                                    &  \\
   \textit{temperature}                  & \textit{celsius}                   & Value measured in                                      & celsius                        &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{AQI}}                                           & \multicolumn{2}{l}{Air Quality Index according to the U.S. AQI}                         &  \\
   \textit{aqi}                          & \textit{value}                     & Value measured in                                      & AQI                            &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{Air Humidity}}                                  & \multicolumn{2}{l}{Concentration of water vapour present in the air}                    &  \\
   \multirow{2}{*}{\textit{airHumidity}} & \textit{gramsPerCubicMeter}        & Value measured in                                      & g/m3                           &  \\
                                         & \textit{relativePercentage}        & Value measured in                                      & \%                             &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{Air Pressure}}                                  & \multicolumn{2}{l}{Pressure within the atmosphere of Earth}                             &  \\
   \textit{airPressure}                  & \textit{hectoPascal}               & Value measured in                                      & hPa                            &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{Battery}}                                       & \multicolumn{2}{l}{Battery of the device}                                               &  \\
   \multirow{4}{*}{\textit{battery}}     & \textit{volts}                     & Value measured in                                      & volts                          &  \\
                                         & \textit{percentage}                & Value measured in                                      & \%                             &  \\
                                         & \textit{maxVolts}                  & Minimum volts the battery needs for the device to work & volts                          &  \\
                                         & \textit{minVolts}                  & Maximum volts the battery can hold                     & volts                          &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{Soil Moisture}}                                 & \multicolumn{2}{l}{Amount of water, including water vapor, in an unsaturated soil}      &  \\
   \textit{soilMoisture}                  & \textit{relativePercentage}        & Value measured in                                      & \%                             &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{Illuminance}}                                   & \multicolumn{2}{l}{Illuminance level - luminous flux per unit area}                     &  \\
   \textit{illuminance}                  & \textit{lux}                       & Value measured in                                      & lux                            &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{Trigger}}                                       & \multicolumn{2}{l}{Type related to something with an on / off or open / close state}    &  \\
   \textit{trigger}                      & \textit{value}                     & Value true or false                                    & boolean                        &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{CO2}}                                           & \multicolumn{2}{l}{Atmospheric Carbon Dioxide concentration}                            &  \\
   \textit{co2}                          & \textit{ppm}                       & Value measured in                                      & ppm                            &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{CO}}                                            & \multicolumn{2}{l}{Atmospheric Carbon Oxide concentration}                              &  \\
   \textit{co}                           & \textit{ppm}                       & Value measured in                                      & ppm                            &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{VOC}}                                           & \multicolumn{2}{l}{Volatile Organic Compounds concentration measured by a device}       &  \\
   \textit{voc}                          & \textit{ppm}                       & Value measured in                                      & ppm                            &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{NH3}}                                           & \multicolumn{2}{l}{Atmospheric Ammonia concentration}                                   &  \\
   \textit{nh3}                          & \textit{ppm}                       & Value measured in                                      & ppm                            &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{O3}}                                            & \multicolumn{2}{l}{Atmospheric Ozone concentration measured by a device}                &  \\
   \textit{o3}                           & \textit{ppm}                       & Value measured in                                      & ppm                            &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{NO2}}                                           & \multicolumn{2}{l}{Atmospheric Nitrogen dioxide concentration}                          &  \\
   \textit{no2}                          & \textit{ppm}                       & Value measured in                                      & ppm                            &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{PM2.5}}                                         & \multicolumn{2}{l}{Particulate Matter in the air (size up to 2.5 micrometers)}          &  \\
   \textit{pm2\_5}                       & \textit{microGramsPerCubicMeter}   & Value measured in                                      & $\mu$g/m3                      &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{PM10}}                                          & \multicolumn{2}{l}{Particulate Matter in the air (size up to 10 micrometers)}           &  \\
   \textit{pm10}                         & \textit{microGramsPerCubicMeter}   & Value measured in                                      & $\mu$g/m3                      &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{Water Pressure}}                                & \multicolumn{2}{l}{Water Pressure measured in pipes by a device}                        &  \\
   \textit{waterPressure}                & \textit{bar}                       & Value measured in                                      & bar                            &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{pH}}                                            & \multicolumn{2}{l}{Scale used to specify how acidic or basic a water-based solution is} &  \\
   \textit{ph}                           & \textit{value}                     & Value between 0 and 14 measured in                     & pH                             &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{Occupation}}                                    & Occupation percentage measured inside a vessel         &                                &  \\
   \textit{occupation}                   & \textit{percentage}                & Value measured in                                      & \%                             &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{Soil Conductivity}}                             & \multicolumn{2}{l}{Substances ability to conduct an electrical current in the soil}     &  \\
   \textit{soilConductivity}             & \textit{microSiemensPerCentimeter} & Value measured in                                      & $\mu$S/cm                      &  \\ \cline{1-4}
   \multicolumn{2}{l}{\textbf{Distance}}                                      & \multicolumn{2}{l}{Distance measured from the device to a surface}                      &  \\
   \multirow{3}{*}{\textit{distance}}    & \textit{millimeters}               & Value measured in                                      & mm                             &  \\
                                         & \textit{maxMillimeters}            & Maximum distance the sensor can be to a given surface  & mm                             &  \\
                                         & \textit{minMillimeters}            & Minimum distance the sensor can be to a given surface  & mm                             &  \\ \cline{1-4}
   \caption{Measure Data Types}
   \label{tab:design:domain:shared_model:data:data_types}\\
   \end{longtable}
\end{landscape}

The current shared model schema can be found in \textbf{***TODO***}.

\subsubsection*{Message Envelop Model}
\label{subsubsec:design:domain:shared_model:message}

The message envelop model refers to how, coupled with the routing model in Section~\ref{subsubsec:design:domain:shared_model:routing}, information can easily transverse the system.
The message envelop is used when a message is expected to flow though the system and is therefore used in all \textbf{Topic}s but the \textbf{Internal} one.

The diagram present in Figure~\ref{fig:design:domain:shared_model:messsage:diagram} details this model.

\begin{figure}[H]
   \centering
  \resizebox{\columnwidth}{!}
  {
     \input{assets/diagrams/message-envelop-model.latex}
  }
  \caption[Message Envelop Model]{Message Envelop Model}
  \label{fig:design:domain:shared_model:messsage:diagram}
\end{figure}

As a brief description:

\begin{itemize}
   \item A \textit{MessageSupplied} is created in a container and supplied to start the flow of information in the system;
   \item A \textit{MessageConsumed} is consumed by a container and can then be transformed into a \textit{MessageSupplied} if needed;
   \item \textit{Information} represents the content of the message;
   \item \textit{RoutingKeys} represents the model referenced in Section~\ref{subsubsec:design:domain:shared_model:routing};
\end{itemize}

This concept is mainly used to ensure that information flowing in the system is not reprocessed, by verifying the unique id - \textit{oid}, and is drooped if it enters a routing loop by verifying that the \textit{hops} have not reached a maximum value.  

\subsubsection*{Routing Model}
\label{subsubsec:design:domain:shared_model:routing}

The routing model refers to how information can be routed through the system based on various parameters. The initial and current idea is based on the \textit{pub/sub} pattern (\textbf{**TODO**}), containers subscribe to information in a \textbf{Topic} with specific \textit{RoutingKey}s and publish information with \textit{RoutingKey}s.

The diagram present in Figure~\ref{fig:design:domain:shared_model:routing:diagram} details this model.

\begin{figure}[H]
   \centering
  \resizebox{\columnwidth}{!}
  {
     \input{assets/diagrams/routing-model.latex}
  }
  \caption[Routing Model]{Routing Model}
  \label{fig:design:domain:shared_model:routing:diagram}
\end{figure}

As a brief description:

\begin{itemize}
   \item \textit{RoutingKeys} is the concept referenced in Figure~\ref{fig:design:domain:shared_model:messsage:diagram} and represents a collection of different \textit{RoutingKeyOption}s;
   \item There are currently 4 types of \textit{RoutingKeys}, one for each \textbf{Topic};
   \item To ensure that the various containers in \textbf{Sensae Console} understand each other a \textit{ProtocolVersionOptions} is provided. This concept follows the Semantic Versioning Specification 2.0 (\cite{semver}) an is constructed according to the version of \textit{iot-core} imported by the container;
   \item There are multiple \textit{RoutingKey} types not displayed in the diagram for brevity.
   \item The \textit{RoutingKeysBuilder} implements the \textit{Builder} pattern and its single responsibility is to validate and create \textit{RoutingKeys};
   \item A \textit{RoutingKeyOption} can have the value \textit{any}, if the \textit{RoutingKeysBuilderOptions} has the value \textit{CONSUMER}. This provides a 'relaxed' mode, for containers that consume/subscribe to messages and a 'strict' mode, where each \textit{RoutingKey} must be specified, for containers that supply/publish messages. 
\end{itemize}

In the Table~\ref{tab:design:domain:shared_model:routing} all currently used \textit{RoutingKey} are presented.

\begin{landscape}
   \begin{longtable}{cll}
   \cline{1-2}
   \multicolumn{1}{l}{\textbf{Topic}}      & \multirow{2}{*}{\textbf{Description}}                                                                     &  \\
   \textit{Routing Key}                    &                                                                                                           &  \\ \cline{1-2}
   \endfirsthead
   %
   \multicolumn{3}{c}%
   {{\bfseries Table \thetable\ continued from previous page}} \\
   \cline{1-2}
   \multicolumn{1}{l}{\textbf{Topic}}      & \multirow{2}{*}{\textbf{Description}}                                                                     &  \\
   \textit{Routing Key}                    &                                                                                                           &  \\ \cline{1-2}
   \endhead
   %
   \cline{1-2}
   \endfoot
   %
   \endlastfoot
   %
   \multicolumn{1}{l}{\textbf{Common}}     & Routing Keys that belong to every Topic                                                                   &  \\
   \textit{Protocol Version Options}       & Version of the used \textit{iot-core} package                                                             &  \\
   \textit{Container Type Options}         & Type of the Container that published the message                                                          &  \\
   \textit{Ownership Options}              & Does the message contains the \textbf{Domain}s that own it\footnotemark[1]                                &  \\
   \textit{Topic Type Options}             & Topic used to publish the message                                                                         &  \\ \cline{1-2}
   \multicolumn{1}{l}{\textbf{Internal}}   & Routing Keys that belong to the Internal Topic                                                            &  \\
   \textit{Operation Type Options}         & Intent of the message, e.g. unknown context found                                                         &  \\
   \textit{Context Type Options}           & Type of content in the message, e.g. device information                                                   &  \\ \cline{1-2}
   \multicolumn{1}{l}{\textbf{Data}}       & Routing Keys that belong to the Data Topic                                                                &  \\
   \textit{Info Type Options}              & How data is shaped: (i) ENCODED, (ii) DECODED and (iii) PROCESSED                                         &  \\
   \textit{Device Type Options}            & Type of device, e.g. LGT-92 or EM300-TH                                                                   &  \\
   \textit{Channel Options}                & Name of channel where data flows, e.g. \textit{smartIrrigation} or \textit{default}                       &  \\
   \textit{Data Legitimacy Options}        & Is the data legitimate: (i) UNKNOWN, (ii) CORRECT, (iii) INCORRECT and (iv) UNDETERMINED      &  \\
   \textit{Records Options}                & Does the data contains \textbf{Records/Metadata}\footnotemark[1]                                          &  \\
   \textit{Air Humidity Data Options}      & Does the data contains information about Air Humidity\footnotemark[1]\footnotemark[2]                     &  \\
   \textit{Air Pressure Data Options}      & Does the data contains information about Air Pressure\footnotemark[1]\footnotemark[2]                     &  \\
   \textit{Air Quality Data Options}       & Does the data contains information about Air Quality\footnotemark[1]\footnotemark[2]                      &  \\
   \textit{Battery Data Options}           & Does the data contains information about the device Battery\footnotemark[1]\footnotemark[2]               &  \\
   \textit{CO2 Data Options}               & Does the data contains information about CO2 levels\footnotemark[1]\footnotemark[2]                       &  \\
   \textit{CO Data Options}                & Does the data contains information about CO levels\footnotemark[1]\footnotemark[2]                        &  \\
   \textit{Distance Data Options}          & Does the data contains information about distances to a surface\footnotemark[1]\footnotemark[2]           &  \\
   \textit{GPS Data Options}               & Does the data contains information about the device GPS coordinates\footnotemark[1]\footnotemark[2]       &  \\
   \textit{Illuminance Data Options}       & Does the data contains information about illuminance in the environment\footnotemark[1]\footnotemark[2]   &  \\
   \textit{Motion Data Options}            & Does the data contains information about the device motion\footnotemark[1]\footnotemark[2]                &  \\
   \textit{NH3 Data Options}               & Does the data contains information about NH3 levels\footnotemark[1]\footnotemark[2]                       &  \\
   \textit{NO2 Data Options}               & Does the data contains information about NO2 levels\footnotemark[1]\footnotemark[2]                       &  \\
   \textit{O3 Data Options}                & Does the data contains information about O3 levels\footnotemark[1]\footnotemark[2]                        &  \\
   \textit{Occupation Data Options}        & Does the data contains information about occupation levels\footnotemark[1]\footnotemark[2]                &  \\
   \textit{pH Data Options}                & Does the data contains information about ph level\footnotemark[1]\footnotemark[2]                         &  \\
   \textit{PM2.5 Data Options}             & Does the data contains information about pm 2.5 concentration\footnotemark[1]\footnotemark[2]             &  \\
   \textit{PM10 Data Options}              & Does the data contains information about pm 10 concentration\footnotemark[1]\footnotemark[2]              &  \\
   \textit{Soil Conductivity Data Options} & Does the data contains information about the soil conductivity\footnotemark[1]\footnotemark[2]            &  \\
   \textit{Soil Moisture Data Options}     & Does the data contains information about the soil moisture\footnotemark[1]\footnotemark[2]                &  \\
   \textit{Temperature Data Options}       & Does the data contains information about the temperature\footnotemark[1]\footnotemark[2]                  &  \\
   \textit{Trigger Data Options}           & Does the data contains information about something that works as a switch\footnotemark[1]\footnotemark[2] &  \\
   \textit{Velocity Data Options}          & Does the data contains information about the device velocity\footnotemark[1]\footnotemark[2]              &  \\
   \textit{VOC Data Options}               & Does the data contains information about VOC concentration\footnotemark[1]\footnotemark[2]                &  \\
   \textit{Water Pressure Data Options}    & Does the data contains information about water pressure\footnotemark[1]\footnotemark[2]                   &  \\ \cline{1-2}
   \multicolumn{1}{l}{\textbf{Command}}    & Routing Keys that belong to the Command Topic                                                             &  \\
   \textit{Command Type Options}           & Type of command, e.g. Open Valve                                                                          &  \\ \cline{1-2}
   \multicolumn{1}{l}{\textbf{Alert}}      & Routing Keys that belong to the Alert Topic                                                               &  \\
   \textit{Alert Category Options}         & Category of the alert published, e.g. Fire Detention                                                      &  \\
   \textit{Alert Subcategory Options}      & Category of the alert published, e.g. Humidity With High Rate Of Change                                   &  \\
   \textit{Alert Severity Options}         & Severity of the alert published, from \textit{Information} level to \textit{Critical} level               &  \\ \cline{1-2}
   \caption{Routing Types}
   \label{tab:design:domain:shared_model:routing}\\
   \end{longtable}
   \footnotetext[1]{has three possible values: (i) UNDETERMINED, (ii) WITH, (iii) WITHOUT}
   \footnotetext[2]{related to the explored Data Types}
   \end{landscape}

Routing keys help to strengthen the boundaries that a container is expected to have. As an example, a Service in the \textbf{Service Scope} related to Waste Management would subscribe to the \textit{Data Topic} with the following \textit{Routing Keys}: 

\begin{itemize}
   \item \textit{Info Type Options}: PROCESSED;
   \item \textit{Channel Options}: 'wasteManagement';
   \item \textit{Data Legitimacy Options}: CORRECT;
   \item \textit{GPS Data Options}: WITH;
   \item \textit{Occupation Data Options}: WITH;
   \item \textit{Records Options}: WITH;
   \item \textit{Ownership Options}: WITH;
\end{itemize}

And would, for example, subscribe to the \textit{Alert Topic} with the following \textit{Routing Keys}:

\begin{itemize}
   \item \textit{Alert Category Options}: 'wasteManagement';
   \item \textit{Alert SubCategory Options}: 'trashAlmostFull'; 
   \item \textit{Ownership Options}: WITH;
\end{itemize}

As expected, the structure and semantics of the information subscribed to are known upfront with the help of the package \textit{iot-core}.

\subsection{Bounded Contexts}
\label{subsec:design:domain:bounded_contexts}

The \textbf{Bounded Context} concept, defined by \cite{evans2014domain}, refers to an unified model - with well-defined boundaries and internally consistent - that is a single piece in a  larger system composed by various bounded contexts.

The \textbf{Sensae Console} is composed by the following bounded contexts:

\begin{itemize}
   \item In \textbf{Configuration/Data Flow Scopes}:
   \begin{itemize}
      \item Data Processor;
      \item Data Decoder;
      \item Device Management;
      \item Identity Management;
      \item Rule Management.
   \end{itemize}
   \item In \textbf{Service Scope}:
   \begin{itemize}
      \item Smart Irrigation;
      \item Fleet Management.
   \end{itemize}
\end{itemize}

Each of this contexts will be briefly addressed in the following sections.

\subsubsection*{Data Processor}
\label{subsubsec:design:domain:bounded_contexts:processor}

The \textbf{Data Processor} context refers to simple data mappers that translate inbound information to \textbf{Data Unit}s, discussed in Section~\ref{subsubsec:design:domain:shared_model:data}.

The received information must be \textit{decoded}, meaning that the inbound information simply has a different structure than \textbf{Data Unit}.

The diagram in Figure~\ref{fig:design:domain:bounded_contexts:processor:diagram} displays the noteworthy concepts in this context.

\begin{figure}[H]
   \centering
  \resizebox{\columnwidth}{!}
  {
     \input{assets/diagrams/data-processor-model.latex}
  }
  \caption[Data Processor Context Model]{Data Processor Context Model}
  \label{fig:design:domain:bounded_contexts:processor:diagram}
\end{figure}

As a brief description:

\begin{itemize}
   \item \textbf{DataMapper}, the root entity in this context is identified by a \textbf{DeviceTypeId} and has various instructions to map properties from the inbound information to a \textbf{Data Unit} properties;
   \item \textbf{DeviceTypeId} corresponds to the \textbf{Routing Key} \textit{Device Type Options} mentioned in Table~\ref{tab:design:domain:shared_model:routing};
   \item \textbf{SubDeviceReference} represents a number that will be used later to reference a sub device when dealing with \textbf{Controller}s. For simple \textbf{Devices} the used and default value is \textit{0}; 
   \item \textbf{PropertyName} has much more properties that haven't been presented for brevity.
\end{itemize}

As an example, one could define an inbound information as a JSON document with the structure in the example \ref{code:design:domain:bounded_contexts:processor:json}. 

To map the \textit{temperature} value to the \textbf{TEMPERATURE\_CELSIUS} property of a \textbf{Data Unit} the \textbf{EncodedDataPropertyPath} would be \textit{decoded.data[0].temperature}.


\begin{lstlisting}[caption=Inbound Information Example, label={code:design:domain:bounded_contexts:processor:json}]
{
   "uuid": "de1a9d15-c018-4547-8453-87111cb4f81b",
   "id": "d81e6e69-1955-48a1-a1dd-4c812c15ebac",
   "time": 1657646955748,
   "decoded": {
      "data": [
         {
            "temperature": 18,
         }
      ]
   }
}
\end{lstlisting}

This process is simple since it expects the inbound information to be predisposed, but when working with \gls{IoT} Devices, to optimize the bandwidth used, it is common to send information encoded. The following section presents an alternative to this process.   

\subsubsection*{Data Decoder}
\label{subsubsec:design:domain:bounded_contexts:decoder}

The \textbf{Data Decoder} context refers to a more complex data mapper that translates inbound information to \textbf{Data Unit}s, discussed in Section~\ref{subsubsec:design:domain:shared_model:data}.
It was created to deal with the limitations mentioned in Section~\ref{subsubsec:design:domain:bounded_contexts:processor}.

The received information is usually \textit{encoded}, meaning that the inbound information is received as it was sent by the \textbf{Device}, commonly as a \textit{Base64} encoded string that needs to be processed so that information can be extracted.

The diagram in Figure~\ref{fig:design:domain:bounded_contexts:decoder:diagram} displays the noteworthy concepts in this context.

\begin{figure}[H]
   \centering
  \resizebox{\columnwidth}{!}
  {
     \input{assets/diagrams/data-decoder-model.latex}
  }
  \caption[Data Decoder Context Model]{Data Decoder Context Model}
  \label{fig:design:domain:bounded_contexts:decoder:diagram}
\end{figure}

As a brief description:

\begin{itemize}
   \item \textbf{DataDecoder}, the root entity in this context is identified by a \textbf{DeviceTypeId} and has a \textbf{Script};
   \item Currently a \textbf{Script} can only be written in \textit{JavaScript} but in the future more languages like \textit{Python} or \textit{Groovy} can be added;
   \item The \textbf{ScriptContent} contains the code that will run for each inbound information that matches the \textbf{DeviceTypeId}.
\end{itemize}

This process requires some programing language knowledge but is much more flexible than the \textbf{Data Processor} operation.

\subsubsection*{Device Management}
\label{subsubsec:design:domain:bounded_contexts:device}

The \textbf{Device Management} context refers to the inventory of all registered \textbf{Device}s in the \textbf{Sensae Console}.

The diagram in Figure~\ref{fig:design:domain:bounded_contexts:device:diagram} displays the noteworthy concepts in this context.

\begin{figure}[H]
   \centering
  \resizebox{\columnwidth}{!}
  {
     \input{assets/diagrams/device-management-model.latex}
  }
  \caption[Device Management Context Model]{Device Management Context Model}
  \label{fig:design:domain:bounded_contexts:device:diagram}
\end{figure}

As a brief description:

\begin{itemize}
   \item A \textbf{Device} is uniquely identified by a \textbf{DeviceId}, has a \textbf{DeviceName} and may have a \textbf{DeviceDownlink};% Apart from this it can also have other details regarding: (i) \textbf{DeviceCommand}s, (ii) \textbf{DeviceRecord}s, (iii) \textbf{DeviceStaticData} and (iv) \textbf{SubDevice};
   \item A \textbf{DeviceCommand} defines how to send a \textbf{Downlink} with a specific action;
   \item A \textbf{DeviceStaticData} helps to define data such as the device location;
   \item A \textbf{DeviceRecord} enriches the device information with anything deemed important. This can also help to group devices by projects, type of utility and others;
   \item A \textbf{SubDevice} references another \textbf{Device} by its \textbf{DeviceId}. This, coupled with the concepts \textbf{SubDeviceMeasures} and \textbf{SubDeviceCommands} presented in Figure~\ref{fig:design:domain:shared_model:data:diagram} help to split a \textbf{Controller}'s \textbf{Data Unit} into various \textbf{Data Unit}, one for each referenced \textbf{SubDevice}.
\end{itemize}

\subsubsection*{Identity Management}
\label{subsubsec:design:domain:bounded_contexts:identity}

The \textbf{Identity Management} is concerned with identifying \textbf{Tenant}s, defining their permissions and what \textbf{Device}s they own.
To simplify this a forth concept is introduced: \textbf{Domain}.

The diagram in Figure~\ref{fig:design:domain:bounded_contexts:identity:diagram} displays the noteworthy concepts in this context.

\begin{figure}[H]
   \centering
  \resizebox{\columnwidth}{!}
  {
     \input{assets/diagrams/identity-management-model.latex}
  }
  \caption[Identity Management Context Model]{Identity Management Context Model}
  \label{fig:design:domain:bounded_contexts:identity:diagram}
\end{figure}

As a brief description:

\begin{itemize}
   \item A \textbf{Domain} is uniquely identified by a \textbf{DomainId} and can have a parent \textbf{Domain};
   \item There's a root \textbf{Domain}, the only one doesn't have a parent and has all available permissions;
   \item A \textbf{Tenant} has a \textbf{TenantName} and \textbf{TenantEmail}, unique \textbf{TenantId} and can have a \textbf{TenantPhoneNumber};
   \item A \textbf{Device} is uniquely identified by a \textbf{DeviceId};
   \item The \textbf{PermissionType} has much more types that haven't been presented for brevity.
\end{itemize}

A \textbf{Domain} represents a department in a hierarchical organization. An organization is composed by several domains in a tree like structure as presented in Figure~\ref{fig:design:domain:bounded_contexts:identity:organization}.

\begin{figure}[H]
   \centering
  \resizebox{\columnwidth}{!}
  {
     \input{assets/diagrams/organization.latex}
  }
  \caption[Domain Structure]{Domain Structure}
  \label{fig:design:domain:bounded_contexts:identity:organization}
\end{figure}

Coupled with the figure above, there are other constrains:

\begin{itemize}
   \item A domain owns all devices in it and in his subdomains;
   \item A domain can only inherit his parent domain permissions;
   \item A tenant has all the domain permissions that he is registered in;
   \item A tenant can only see the devices that the domains he is registered in has access to;
   \item All \textit{Unallocated} domains have no permissions or devices and contain only tenants that are waiting to be assigned to a department or organization;
   \item The \textit{Public} domain can be accessed by any tenant, including those who are not authenticated in the system;
\end{itemize}

\subsubsection*{Rule Management}
\label{subsubsec:design:domain:bounded_contexts:rule}

The \textbf{Rule Management} context refers to rule scenarios that produce \textbf{Alert}s based on incoming \textbf{Data Unit}s. 

The diagram in Figure~\ref{fig:design:domain:bounded_contexts:rule:diagram} displays the noteworthy concepts in this context.

\begin{figure}[H]
   \centering
  \resizebox{\columnwidth}{!}
  {
     \input{assets/diagrams/rule-management-model.latex}
  }
  \caption[Rule Management Context Model]{Rule Management Context Model}
  \label{fig:design:domain:bounded_contexts:rule:diagram}
\end{figure}

\subsubsection*{Notification Management}
\label{subsubsec:design:domain:bounded_contexts:notification}

The \textbf{Notification Management} context refers to notifications and how/what types an addressee wants to receive. There are two main concepts in this context, a notification and an addressee.

The diagram in Figure~\ref{fig:design:domain:bounded_contexts:notification:diagram} displays the noteworthy concepts in this context.

\begin{figure}[H]
   \centering
  \resizebox{\columnwidth}{!}
  {
     \input{assets/diagrams/notification-management-model.latex}
  }
  \caption[Notification Management Context Model]{Notification Management Context Model}
  \label{fig:design:domain:bounded_contexts:notification:diagram}
\end{figure}
 
As a brief description:

\begin{itemize}
   \item A \textbf{Notification} is a sanitized \textbf{Alert} that was captured with the intent to be presented or delivered to addressees, its identified by an \textbf{NotificationId};
   \item An \textbf{Addressee} is someone that receives notifications based on his configurations and is identified by an \textbf{AddresseeId};
   \item An \textbf{AddresseeConfiguration} defines for each type of notification - \textbf{ContentType} - what will be the delivery method - \textbf{DeliveryType};
   \item A \textbf{DeliveryType} can be of four types: (i) present in SPA - \textbf{UI}, (ii) publish notification in SPA - \textbf{NOTIFICATION}, (iii) send an email - \textbf{EMAIL}, (iv) send an SMS - \textbf{SMS}; 
   \item A \textbf{ContentType} is derived from the \textbf{Alert} Routing Keys mentioned in the Table~\ref{tab:design:domain:shared_model:routing} and defines the type of each \textbf{Notification};
   \item A \textbf{NotificationContext} is data that can help to correlate the \textbf{Notification} with other contexts such as what devices - \textbf{DeviceIdContext} - were involved in the \textbf{Alert} trigger, or what domains - \textbf{DomainIdContext} - need to be notified, or what \textbf{Data Unit}s - \textbf{DataIdContext} - are related to the \textbf{Alert};
   \item To enforce accountability in the system, the notion of who read a specific notification and when was added - \textbf{NotificationRead}.
\end{itemize}

\subsubsection*{Smart Irrigation}
\label{subsubsec:design:domain:bounded_contexts:irrigation}

The \textbf{Smart Irrigation} context refers to irrigation zones, sensors that read environmental conditions in this zones, valves and the associated readings. This concepts are divided in three diagrams presented below.

The diagram in Figure~\ref{fig:design:domain:bounded_contexts:irrigation:diagram:garden} displays the noteworthy concepts related to irrigation zones.

An irrigation zone is an area intended to function as an isolated environment that may or may not have valves or sensors.

\begin{figure}[H]
   \centering
  \resizebox{\columnwidth}{!}
  {
     \input{assets/diagrams/smart-irrigation-model-2.latex}
  }
  \caption[Smart Irrigation Context Model - Irrigation Zone]{Smart Irrigation Context Model - Irrigation Zone}
  \label{fig:design:domain:bounded_contexts:irrigation:diagram:garden}
\end{figure}

A sensor or valve belongs to an irrigation zone if it is inside the zone's \textbf{Area}.

As presented in the following diagram, Figure~\ref{fig:design:domain:bounded_contexts:irrigation:diagram:device}, a sensor/valve can be represents by a \textbf{Device}.

\begin{figure}[H]
   \centering
  \resizebox{\columnwidth}{!}
  {
     \input{assets/diagrams/smart-irrigation-model-3.latex}
  }
  \caption[Smart Irrigation Context Model - Device]{Smart Irrigation Context Model - Device}
  \label{fig:design:domain:bounded_contexts:irrigation:diagram:device}
\end{figure}

As a brief description:

\begin{itemize}
   \item A \textbf{Valve} can be controlled remotely if two types of \textbf{Command}s are sent with the device \textbf{Data Unit}: \textit{OpenValve} and \textit{CloseValve};
   \item A \textbf{Device} is identified by its \textbf{DeviceId};
   \item Each \textbf{Device} stores an history of all its changes such as name, location or metadata in \textbf{Content}, the same \textbf{LedgerEntry} is used as long as this values don't change;
   \item There are three types of \textbf{Device}: (i) Green House Sensor, (ii) Park Sensor, (iii) Valve. Each of this types collect different measures discussed in Figure\ref{fig:design:domain:bounded_contexts:irrigation:diagram:reading}.
\end{itemize}

As mentioned above each type of device collects different readings. The following diagram, Figure\ref{fig:design:domain:bounded_contexts:irrigation:diagram:reading}, details this readings.

\begin{figure}[H]
   \centering
  \resizebox{\columnwidth}{!}
  {
     \input{assets/diagrams/smart-irrigation-model-4.latex}
  }
  \caption[Smart Irrigation Context Model - Reading]{Smart Irrigation Context Model - Reading}
  \label{fig:design:domain:bounded_contexts:irrigation:diagram:reading}
\end{figure}

As a brief description:

\begin{itemize}
   \item A \textbf{Reading} is always identified by its \textbf{ReadingId} and is associated to the instant that it was captured by the \textbf{Device} - \textbf{ReportedTime};
   \item A \textbf{ParkSensorReading} measures soil moisture and illuminance;
   \item A \textbf{Valve} indicates if it is open or closed;
   \item A \textbf{GreenHouseSensor} measures air humidity and air temperature.
\end{itemize}

\subsubsection*{Fleet Management}
\label{subsubsec:design:domain:bounded_contexts:fleet}

The \textbf{Fleet Management} context simply refers to the past and current location of assets. 

The diagram in Figure~\ref{fig:design:domain:bounded_contexts:fleet:diagram} displays the noteworthy concepts related to this context.

\begin{figure}[H]
   \centering
  \resizebox{\columnwidth}{!}
  {
     \input{assets/diagrams/fleet-management-model.latex}
  }
  \caption[Fleet Management Context Model]{Fleet Management Context Model}
  \label{fig:design:domain:bounded_contexts:fleet:diagram}
\end{figure}

This was the first \textit{Service} built as an \gls{MVP}, it was intended to be straightforward. The model references \gls{GPS} readings and what device collected them.

\subsection{Synopsis}
\label{subsec:design:domain:synopsis}

In this section the various domains that \textbf{Sensae Console} incorporates are described. This domains share some concepts such as \textbf{Device} but it isn't clear how they interact with each other. In the next section - \nameref{sec:design:architecture} - it will be addressed how this domains are connected and cooperate.   

\section{Architectural Design}
\label{sec:design:architecture}

In order to describe the system in detail at the architectural level, an approach based on the combination of two models, C4 (\cite{c4model-site}) and 4+1  will be followed.

The 4+1 View Model (\cite{4plus1model}), proposes the description of the system through complementary views thus allowing to separately analyze the requirements of various software stakeholders, such as users, system administrators, project managers, architects, and programmers.

The five views are thus defined as follows:
\begin{itemize}
   \item \textbf{Logical view}: relative to the aspects of the software aimed at responding to business challenges;
   \item \textbf{Process view}: relative to the process flow or interactions within the system;
   \item \textbf{Development view}: relative to the organization of the software in its development environment;
   \item \textbf{Physical view}: relative to the mapping of the various components of the software in hardware, i.e. where the software is executed;
   \item \textbf{Scenario view}: related to the association of business processes with actors capable of triggering them.
\end{itemize}

The C4 Model (\cite{c4model-site}, \cite{c4model}) advocates describing software through four levels of abstraction:
(i) system, (ii) container, (iii) component, (iv) code. Each level adopts a finer granularity than the level that precedes it, thus giving access to more details of a smaller portion of the system.
These levels can be likened to maps, e.g. the system view corresponds to the globe, the container corresponds to the map of each continent, the component view corresponds to the map of each of each country, and the code view to the map of roads and neighborhoods in each city.

Different levels allow you to tell different stories to different audiences.

The levels are defined as follows:
\begin{itemize}
   \item \textbf{Level 1}: Description (context) of the system as a whole;
   \item \textbf{Level 2}: Description of system containers;
   \item \textbf{Level 3}: Description of components of the containers;
   \item \textbf{Level 4}: Description of the code or smaller parts of the components.
\end{itemize}

These two models can be said to expand along distinct axes, with the
C4 Model presenting the system with different levels of detail and the 4+1 View Model presents the system from different perspectives. By combining the two models it becomes possible to represent the system from several perspectives, each with various levels of detail.
To visually model/represent the ideas designed and alternatives considered, the \gls{UML} was used.

In the following sections only combinations of perspectives and level deemed relevant for the design of the solution are presented.

The C4 level 4, code, will not be exhibited.

\subsection{C4 Level 1 - Context}
\label{subsec:design:architecture:context}

The context level aims at introducing the system as a whole. The external systems and users that communicate/interact with the system, \textbf{Sensae Console}, are demonstrated.
Throughout this section the relevant C4 views of level 1 (context level) are presented.

\subsubsection*{Context Level - Logical View}
\label{subsubsec:design:architecture:context:logical}

The logical view of the system is introduced here, complete but not detailed, in order to answer the use cases and requirements discussed in \textbf{***TODO***}. This takes into account the interactions of the platform with external systems and its interaction with the various actors of the system (Figure~\ref{fig:design:architecture:context:logical:diagram}).

\begin{figure}[H]
   \centering
   \resizebox{\columnwidth}{!}
   {
      \input{assets/diagrams/logical-view-level1.latex}
   }
   \caption[Context Level - Logical View Diagram]{Context Level - Logical View Diagram}
   \label{fig:design:architecture:context:logical:diagram}
\end{figure}

The external systems and its functions are as follows:
\begin{itemize}
   \item \textbf{Helium Console}: Device data hub;
   \item \textbf{Azure Active Directory}: User authentication/identity;
   \item \textbf{Google Identity Platform}: User authentication/identity;
   \item \textbf{Twilio Platform}: SMS delivery;
   \item \textbf{Google Email Platform}: Email delivery.
\end{itemize}

The reason behind the use of external authentication/identity services is described in the Section~\ref{subsec:design:alternatives:auth}.

\subsubsection*{Context Level - Physical View}
\label{subsubsec:design:architecture:context:physical}

Next is the physical view (Figure~\ref{fig:design:architecture:context:physical:diagram}), intended to familiarize the reader with the idealized production environment.

\begin{figure}[H]
   \centering
   \resizebox{\columnwidth}{!}
   {
      \input{assets/diagrams/physical-view-level1.latex}
   }
   \caption[Context Level - Physical View Diagram]{Context Level - Physical View Diagram}
   \label{fig:design:architecture:context:physical:diagram}
\end{figure}

Due to time constrains the environment was not deployed to \textit{Kubernetes} and the solution is instead orchestrated using \textit{Docker Compose} in a single node/server.

\subsubsection*{Context Level - Development View}
\label{subsubsec:design:architecture:context:development}

Next is the development view (Figure~\ref{fig:design:architecture:context:development:diagram}), intended to familiarize the reader with how the software is organized.

\begin{figure}[H]
   \centering
      \input{assets/diagrams/development-view-level1.latex}
   \caption[Context Level - Development View Diagram]{Context Level - Development View Diagram}
   \label{fig:design:architecture:context:development:diagram}
\end{figure}

The package \textit{iot-core} contains the shared model discussed in the Section~\ref{subsec:design:domain:shared_model}, and functions to define what type of information a backend containers wants to subscribe or publish (discussed in Section~\ref{subsec:design:domain:concepts}).

The package \textit{sensae-console} contains software of the various containers needed to run the \textbf{Sensae Console}. As expected \textit{iot-core} is a core dependency for the \textit{sensae-console} backend containers.

\subsubsection*{Context Level - Synopsis}
\label{subsubsec:design:architecture:context:synopsis}

The context level introduces the reader to the bigger picture of \textbf{Sensae Console}, but it contains little to none information about how the system functions internally, the Section~\ref{subsec:design:architecture:containers} will dive into this subject.
The process view was not represented since at this level the interactions between the system, actors and external systems, are too abstract to be relevant for the reader.

\subsection{C4 Level 2 - Containers}
\label{subsec:design:architecture:containers}

\subsection{C4 Level 3 - Components}
\label{subsec:design:architecture:components}

\section{Architectural Alternatives Discussed}
\label{sec:design:alternatives}

\subsection{Data Streaming/Pipeline}
\label{subsec:design:alternatives:streaming}

\subsection{User Authorization/Authentication}
\label{subsec:design:alternatives:auth}

\subsection{Internal Communication}
\label{subsec:design:alternatives:communication}

\section{Synopsis}
\label{sec:design:synopsis}
